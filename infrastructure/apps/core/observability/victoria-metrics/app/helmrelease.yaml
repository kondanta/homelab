---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/source.toolkit.fluxcd.io/ocirepository_v1beta2.json
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: OCIRepository
metadata:
  name: vm # VictoriaMetricsK8sStack
spec:
  interval: 5m
  layerSelector:
    mediaType: application/vnd.cncf.helm.chart.content.v1.tar+gzip
    operation: copy
  ref:
    tag: 0.58.2
  url: oci://ghcr.io/victoriametrics/helm-charts/victoria-metrics-k8s-stack
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: vm #VictoriaMetrics
spec:
  interval: 15m
  chartRef:
    kind: OCIRepository
    name: vm
  values:
    # Disable components we don't need yet to save resources
    vmalert:
      enabled: false
    vmalertmanager:
      enabled: false
    vmsingle:
      extraArgs:
        search.enableLabelAPI: "true"

      storage:
        volumeClaimTemplate:
          spec:
            accessModes: ["ReadWriteOnce"]
            storageClassName: longhorn
            resources:
              requests:
                storage: 10Gi

    vmagent:
      spec:
        serviceMonitorNamespaceSelector: {}
        podMonitorNamespaceSelector: {}
        serviceMonitorSelector: {}
        podMonitorSelector: {}
        extraScrapeConfigs:
          - job_name: "kubernetes-pods-annotated"
            kubernetes_sd_configs:
              - role: pod
            relabel_configs:
              - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
                action: keep
                regex: true
              - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
                action: replace
                target_label: __metrics_path__
                regex: (.+)
              - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
                action: replace
                regex: ([^:]+)(?::\d+)?;(\d+)
                replacement: $1:$2
                target_label: __address__
              - action: labelmap
                regex: __meta_kubernetes_pod_label_(.+)
              - source_labels: [__meta_kubernetes_namespace]
                action: replace
                target_label: namespace
              - source_labels: [__meta_kubernetes_pod_name]
                action: replace
                target_label: pod
    kube-state-metrics:
      enabled: true # TODO: This doesn't support customResourceState. I'll deploy it separately.
      vmScrape:
        enabled: true
    grafana:
      enabled: false

    defaultDashboards:
      enabled: true
      labels:
        key: value
      annotations:
        key: value
